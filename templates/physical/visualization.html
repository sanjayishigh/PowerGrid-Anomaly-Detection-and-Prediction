{% extends 'physical/base.html' %}

{% block content %}
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

<style>
    /* FIX: Background is now Pure Black to match your image */
    body { background-color: #000000; }

    /* MAIN WRAPPER */
    #viz-wrapper {
        display: flex;
        height: calc(100vh - 100px);
        margin: 20px;
        background-color: #020617; /* Deepest black-blue */
        
        /* Industrial Border */
        border: 1px solid #334155;
        border-radius: 6px; 
        box-shadow: 0 0 50px rgba(0, 0, 0, 1); /* Strong shadow for depth */
        
        overflow: hidden;
        position: relative;
    }

    /* GRAPH AREA */
    #mynetwork {
        flex-grow: 1;
        /* Subtle radial gradient for depth */
        background: radial-gradient(circle at center, #111827 0%, #000000 80%);
        position: relative;
        cursor: crosshair;
    }
    #mynetwork:active { cursor: grabbing; }

    /* SIDEBAR */
    #sidebar {
        width: 320px;
        background: rgba(15, 23, 42, 0.95);
        border-left: 1px solid #334155;
        display: flex;
        flex-direction: column;
        color: #f1f5f9;
        font-family: 'JetBrains Mono', monospace; 
        z-index: 10;
        backdrop-filter: blur(10px);
    }

    /* HEADER */
    .sidebar-header {
        padding: 1.5rem;
        background: rgba(2, 6, 23, 0.8);
        border-bottom: 1px solid #334155;
    }
    .sidebar-header h2 {
        margin: 0;
        color: #00ff41; /* Cyber Green Title */
        font-size: 1.1rem;
        font-weight: 800;
        letter-spacing: 2px;
        text-transform: uppercase;
        text-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
    }
    .status-indicator {
        font-size: 0.8rem; 
        color: #94a3b8; 
        margin-top: 8px; 
        display: flex; 
        align-items: center; 
        gap: 8px;
    }
    .led { width: 8px; height: 8px; background: #3b82f6; border-radius: 50%; box-shadow: 0 0 8px #3b82f6; }

    /* LIST */
    #node-list {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
        scrollbar-width: thin;
        scrollbar-color: #475569 #0f172a;
    }
    
    /* NODE CARDS */
    .node-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid #334155;
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }
    .node-card:hover {
        background: rgba(255,255,255,0.08);
        transform: translateX(4px);
    }
    
    .node-header { display: flex; justify-content: space-between; align-items: center; }
    .node-id { font-weight: 700; font-size: 0.9rem; color: #fff; }
    
    .node-badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 2px; font-weight: bold; text-transform: uppercase; }
    .badge-zone { background: rgba(255,255,255,0.1); color: #cbd5e1; border: 1px solid #475569; }
    .badge-err { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }

    /* CONTROLS BAR */
    #controls {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 5;
        display: flex;
        gap: 10px;
    }

    .control-el {
        background: rgba(0, 0, 0, 0.8);
        color: #00ff41;
        border: 1px solid #00ff41;
        padding: 8px 16px;
        font-weight: bold;
        border-radius: 4px;
        cursor: pointer;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
        outline: none;
        transition: 0.3s;
    }
    .control-el:hover { background: #00ff41; color: #000; box-shadow: 0 0 15px rgba(0, 255, 65, 0.4); }
    
    select.control-el {
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300ff41%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 0.7em top 50%;
        background-size: 0.65em auto;
        padding-right: 2em;
    }

    /* CUSTOM TOOLTIP STYLE (Matching your screenshot) */
    div.vis-tooltip {
        background-color: rgba(15, 23, 42, 0.95) !important;
        color: #e2e8f0 !important;
        border: 2px solid #fbbf24 !important; /* Amber border */
        border-radius: 6px !important;
        padding: 12px !important;
        font-family: 'JetBrains Mono', monospace !important;
        font-size: 13px !important;
        box-shadow: 0 10px 25px rgba(0,0,0,0.8) !important;
        z-index: 1000 !important;
    }
</style>

<div id="viz-wrapper">
    <div id="mynetwork">
        <div id="controls">
            <button class="control-el" onclick="loadGridData()">
                <span id="sync-text">↻ SYNC</span>
            </button>
            <select id="zone-select" class="control-el" onchange="filterZone()">
                <option value="ALL">VIEW: ENTIRE GRID</option>
            </select>
        </div>

        <div style="position: absolute; bottom: 20px; left: 20px; color: #64748b; font-size: 0.75rem; pointer-events: none; font-family: 'JetBrains Mono', monospace;">
            // SCROLL TO ZOOM • DRAG TO PAN • HOVER FOR DETAILS
        </div>
    </div>

    <div id="sidebar">
        <div class="sidebar-header">
            <h2>Grid Topology</h2>
            <div class="status-indicator">
                <span class="led"></span> SYSTEM ONLINE
                <span style="margin-left:auto; color:#fff;" id="sensor-count">0 SENSORS</span>
            </div>
        </div>
        <div id="node-list">
            <div style="text-align: center; margin-top: 60px; color: #64748b; font-size: 0.9rem;">
                Initializing SCADA link...
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    const container = document.getElementById('mynetwork');
    let network = null;
    let fullData = null;
    const DATA_URL = "{{ url_for('physical_graph_data') }}";
    
    // Zone Colors
    const ZONE_COLORS = ['#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b'];

    const options = {
        nodes: {
            shape: 'dot',
            size: 24,
            font: { 
                size: 16, 
                color: '#ffffff', 
                face: 'JetBrains Mono', 
                strokeWidth: 4, 
                strokeColor: '#000000',
                // FIX 1: Push text strictly BELOW the node
                vadjust: 45 
            },
            borderWidth: 3,
            shadow: { enabled: true, color: 'rgba(0,0,0,0.8)', size: 10 }
        },
        edges: {
            width: 1.5,
            color: { color: '#475569', opacity: 0.4 },
            smooth: { type: 'continuous', roundness: 0.2 }
        },
        physics: {
            enabled: true,
            solver: 'forceAtlas2Based',
            forceAtlas2Based: { 
                gravitationalConstant: -100, 
                centralGravity: 0.005, 
                springLength: 200, 
                springConstant: 0.08, 
                damping: 0.9
            },
            stabilization: { iterations: 150 }
        },
        interaction: {
            hover: true,
            tooltipDelay: 50,
            zoomView: true
        }
    };

    function loadGridData() {
        const syncText = document.getElementById('sync-text');
        syncText.innerText = "...";
        
        fetch(`${DATA_URL}?t=${Date.now()}`)
            .then(response => response.json())
            .then(data => {
                fullData = data;
                populateZoneMenu(data.nodes);
                renderGraph(data.nodes, data.links);
                syncText.innerText = '↻ SYNC';
            })
            .catch(err => {
                console.error(err);
                syncText.innerText = "⚠ ERROR";
            });
    }

    function populateZoneMenu(nodes) {
        const select = document.getElementById('zone-select');
        if (select.options.length > 1) return;

        const zones = [...new Set(nodes.map(n => n.zone_id))].sort((a,b) => a - b);
        zones.forEach(z => {
            const opt = document.createElement('option');
            opt.value = z;
            opt.innerText = `VIEW: ZONE ${z}`;
            select.appendChild(opt);
        });
    }

    function filterZone() {
        const selectedZone = document.getElementById('zone-select').value;
        if (selectedZone === "ALL") {
            renderGraph(fullData.nodes, fullData.links);
        } else {
            const zId = parseInt(selectedZone);
            const filteredNodes = fullData.nodes.filter(n => n.zone_id === zId);
            const nodeIds = new Set(filteredNodes.map(n => n.id));
            const filteredLinks = fullData.links.filter(l => nodeIds.has(l.source) && nodeIds.has(l.target));
            renderGraph(filteredNodes, filteredLinks);
        }
    }

    function renderGraph(nodeData, linkData) {
        const visNodes = new vis.DataSet(nodeData.map(node => {
            const isAnomaly = node.group === 'Anomaly';
            const zoneColor = ZONE_COLORS[node.zone_id % ZONE_COLORS.length];
            const finalColor = isAnomaly ? '#ef4444' : zoneColor;
            const borderColor = isAnomaly ? '#b91c1c' : '#ffffff';

            // FIX 2: CREATE DOM ELEMENT FOR TOOLTIP
            // This prevents the "<div>" tags from showing as text
            const tooltipEl = document.createElement("div");
            tooltipEl.style.textAlign = "left";
            tooltipEl.style.lineHeight = "1.5";
            tooltipEl.innerHTML = `
                <strong style="color: #fbbf24; font-size:1.1em;">SENSOR: ${node.label}</strong><br>
                <span style="color: #94a3b8;">ZONE:</span> ${node.zone_id}<br>
                <span style="color: #94a3b8;">STATUS:</span> <span style="color: ${isAnomaly ? '#ef4444' : '#3b82f6'}; font-weight:bold;">${node.group}</span><br>
                <span style="color: #94a3b8;">LOAD:</span> <span style="color: #fff;">${node.power}</span>
            `;

            return {
                id: node.id,
                label: node.label,
                value: node.val,
                group: node.group,
                zone_id: node.zone_id,
                color: { background: finalColor, border: borderColor },
                title: tooltipEl // Pass the DOM element!
            };
        }));

        const visEdges = new vis.DataSet(linkData.map(link => ({
            from: link.source, to: link.target
        })));

        if (network !== null) { network.destroy(); network = null; }
        
        network = new vis.Network(container, { nodes: visNodes, edges: visEdges }, options);
        updateSidebar(nodeData, network);
        document.getElementById('sensor-count').innerText = `${nodeData.length} SENSORS`;
        
        network.on("doubleClick", function (params) {
            if (params.nodes.length > 0) {
                network.focus(params.nodes[0], { animation: true, scale: 1.8, offset: {x: 0, y: 0} });
            }
        });
    }

    function updateSidebar(nodesData, networkInstance) {
        const list = document.getElementById('node-list');
        list.innerHTML = ""; 

        nodesData.sort((a, b) => {
            if (a.group !== b.group) return (b.group === 'Anomaly') - (a.group === 'Anomaly');
            return a.zone_id - b.zone_id;
        });

        nodesData.forEach(node => {
            const isAnomaly = node.group === 'Anomaly';
            const zoneColor = ZONE_COLORS[node.zone_id % ZONE_COLORS.length];
            
            const div = document.createElement('div');
            div.className = `node-card`;
            div.style.borderLeftColor = isAnomaly ? '#ef4444' : zoneColor;
            
            div.innerHTML = `
                <div class="node-header">
                    <span class="node-id">${node.label}</span>
                    <span class="node-badge ${isAnomaly ? 'badge-err' : 'badge-zone'}">
                        ${isAnomaly ? '⚠ FAULT' : 'ZONE ' + node.zone_id}
                    </span>
                </div>
                <div style="font-size:0.75rem; color:#94a3b8; margin-top:4px;">
                    Load: <span style="color:#fff">${node.power}</span>
                </div>
            `;
            
            div.onclick = () => {
                networkInstance.focus(node.id, { scale: 1.8, animation: { duration: 800, easingFunction: 'easeInOutQuad' } });
                networkInstance.selectNodes([node.id]);
            };
            list.appendChild(div);
        });
    }

    loadGridData();
</script>
{% endblock %}